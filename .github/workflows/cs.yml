name: Deploy AIRSS Azure Cognitive Services and OpenAI

on:
  push:
    branches:
      - releases/v1.4
    paths:
      - './cs.bicep'
  pull_request:
    branches:
      - releases/v1.4
    paths:
      - './**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_RESOURCE_GROUP: 'Rg-AIRSS-PRD-01'
  AZURE_LOCATION: 'eastus'
  BICEP_FILE: './cs.bicep'
  PARAMETERS_FILE: './main.parameters.json'

jobs:
  validate:
    name: Validate Bicep Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep template
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.BICEP_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
          deploymentMode: Validate

  preview:
    name: Preview Changes (What-If)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run What-If
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.BICEP_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
          additionalArguments: '--what-if'

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group (if not exists)
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }}

      - name: Deploy Bicep template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.BICEP_FILE }}
          parameters: ${{ env.PARAMETERS_FILE }}
          deploymentName: cognitive-openai-${{ github.run_number }}
          failOnStdErr: false

      - name: Output deployment results
        run: |
          echo "Cognitive Services Endpoint: ${{ steps.deploy.outputs.cognitiveServicesEndpoint }}"
          echo "OpenAI Endpoint: ${{ steps.deploy.outputs.openAiEndpoint }}"

      - name: Azure Logout
        if: always()
        run: az logout
